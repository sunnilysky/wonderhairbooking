<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Wonder Hair</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#c45c4a" />
  <meta name="description" content="Wonder Hair é ç´„ç®¡ç†ï¼šæœˆæ›†æª¢è¦–ã€ç•¶æ—¥é ç´„åˆ—è¡¨èˆ‡æ–°å¢é ç´„ã€‚" />
  <style>
    :root {
      --primary: #c45c4a;
      --primary-dark: #a84a3a;
      --primary-light: #fdf0ee;
      --accent: #2d5a4a;
      --accent-light: #e8f2ef;
      --bg: #f5f5f4;
      --card-bg: #ffffff;
      --border: #e7e5e4;
      --text-main: #1c1917;
      --text-sub: #78716c;
      --success: #059669;
      --success-bg: #ecfdf5;
      --danger: #dc2626;
      --danger-bg: #fef2f2;
      --radius: 12px;
      --radius-lg: 16px;
      --touch: 44px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-lg: 0 4px 12px rgba(0,0,0,0.08);
      --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      line-height: 1.5;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px 16px 24px;
      padding-left: max(16px, env(safe-area-inset-left));
      padding-right: max(16px, env(safe-area-inset-right));
    }

    header {
      padding: 8px 0 16px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    header p {
      margin: 6px 0 0;
      font-size: 14px;
      color: var(--text-sub);
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }

    .form {
      display: grid;
      gap: 10px;
      margin-bottom: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 13px;
      color: var(--text-sub);
    }

    .field input,
    .field select,
    .field textarea {
      font: inherit;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .field input:focus-visible,
    .field select:focus-visible,
    .field textarea:focus-visible {
      outline: none;
    }

    .field-half-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    textarea {
      min-height: 56px;
      resize: vertical;
    }

    .btn-primary {
      width: 100%;
      min-height: var(--touch);
      border-radius: var(--radius);
      border: none;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.15s var(--ease), box-shadow 0.15s var(--ease);
    }

    .btn-primary:hover { box-shadow: 0 4px 12px rgba(196,92,74,0.35); }
    .btn-primary:active {
      transform: scale(0.98);
      box-shadow: 0 2px 6px rgba(196,92,74,0.25);
    }
    .btn-primary:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }

    .btn-secondary, .btn-danger {
      border-radius: var(--radius);
      border: none;
      min-height: 36px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s var(--ease), transform 0.1s var(--ease);
    }
    .btn-secondary:active, .btn-danger:active { transform: scale(0.97); }

    .btn-secondary {
      background: var(--border);
      color: var(--text-main);
    }
    .btn-secondary:hover { background: #d6d3d1; }

    .btn-danger {
      background: var(--danger-bg);
      color: var(--danger);
    }
    .btn-danger:hover { background: #fee2e2; }

    .tabs-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin: 10px 0 4px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex: 1;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      color: var(--text-sub);
    }

    .tab.active {
      background: #fee2e2;
      border-color: #fecaca;
      color: var(--primary-dark);
      font-weight: 600;
    }

    .btn-link-small {
      border: none;
      background: transparent;
      color: #2563eb;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .btn-link-small:active {
      background: #e0ecff;
    }

    .quick-summary {
      margin-top: 4px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      font-size: 12px;
      color: #9a3412;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .quick-summary-label {
      font-weight: 600;
    }

    .quick-summary-main {
      font-weight: 500;
    }

    .quick-summary-next {
      color: #c2410c;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .list-header-title {
      font-size: 15px;
      font-weight: 600;
    }

    .list-header span {
      font-size: 12px;
      color: var(--text-sub);
    }

    .appointments {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      padding-bottom: 6px;
    }

    .item {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 10px 12px;
      border: 1px solid var(--border);
      transition: box-shadow 0.15s var(--ease);
    }
    .item:hover { box-shadow: var(--shadow); }

    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .item-name {
      font-size: 15px;
      font-weight: 600;
    }

    .item-time {
      font-size: 13px;
      color: var(--primary-dark);
      font-weight: 600;
    }

    .item-service {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .item-note {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-sub);
      white-space: pre-wrap;
    }

    .item-footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-sub);
      gap: 4px;
    }

    .item-actions {
      display: flex;
      gap: 4px;
    }

    .empty {
      font-size: 13px;
      color: var(--text-sub);
      text-align: center;
      padding: 16px 8px;
    }

    .badge-today {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      background: #ecfdf5;
      color: #059669;
      border-radius: 999px;
      padding: 3px 7px;
    }

    .badge-all {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      border-radius: 999px;
      padding: 3px 7px;
    }

    .small-input-row {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .small-input-row input[type="search"] {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      font-size: 12px;
      background: #f9fafb;
    }

    /* ä¸»è¦–åœ–åˆ‡æ›ï¼šæœˆæ›†é¦–é  / æ—¥æœŸè©³æƒ… */
    .view-calendar,
    .view-day {
      display: none;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      animation: viewIn 0.25s var(--ease);
    }
    @keyframes viewIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .view-calendar.active,
    .view-day.active {
      display: flex;
    }

    /* æœˆæ›†ï¼ˆé¦–é ä¸»å…§å®¹ï¼‰ */
    .calendar-main {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      border: 1px solid var(--border);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .calendar-title {
      font-size: 15px;
      font-weight: 600;
    }

    .calendar-nav {
      display: flex;
      gap: 4px;
    }

    .calendar-nav button {
      border: none;
      background: var(--border);
      border-radius: var(--radius);
      min-height: 36px;
      padding: 6px 12px;
      font-size: 13px;
      color: var(--text-main);
      cursor: pointer;
      transition: background 0.15s var(--ease);
    }
    .calendar-nav button:hover { background: #d6d3d1; }
    .calendar-nav button:active { transform: scale(0.98); }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      font-size: 11px;
      color: var(--text-sub);
      text-align: center;
      margin-bottom: 4px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 12px;
    }

    .calendar-day {
      border-radius: 10px;
      padding: 6px 2px;
      text-align: center;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid transparent;
      color: var(--text-sub);
      transition: background 0.15s var(--ease), border-color 0.15s var(--ease);
    }

    .calendar-day-other {
      opacity: 0.25;
    }

    .calendar-day-today {
      border-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }

    .calendar-day-has {
      background: var(--accent-light);
      border-color: #86efac;
      color: var(--accent);
      font-weight: 600;
    }

    .calendar-day:active {
      transform: scale(0.95);
      transition: transform 0.1s var(--ease);
    }

    .calendar-today-summary {
      margin-top: 12px;
      padding: 12px 14px;
      background: var(--primary-light);
      border-radius: var(--radius);
      border: 1px solid #f5d5d0;
      font-size: 14px;
      color: var(--text-main);
    }
    .calendar-today-summary strong { color: var(--primary-dark); }

    .calendar-footer {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-sub);
    }

    /* Toast æç¤º */
    .toast-wrap {
      position: fixed;
      bottom: max(24px, env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      z-index: 100;
      opacity: 0;
      transition: transform 0.3s var(--ease), opacity 0.3s var(--ease);
      pointer-events: none;
    }
    .toast-wrap.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .toast {
      padding: 12px 20px;
      background: var(--text-main);
      color: #fff;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      white-space: nowrap;
    }
    .toast.success { background: var(--success); }
    .toast.danger { background: var(--danger); }

    /* å¿«é€Ÿæ™‚é–“éˆ• */
    .quick-time-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 4px;
    }
    .quick-time-btn {
      border: 1px solid var(--border);
      background: var(--bg);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      color: var(--text-sub);
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s, color 0.15s;
    }
    .quick-time-btn:hover, .quick-time-btn:focus {
      border-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary-dark);
    }

    /* å·²é ç´„æ™‚æ®µï¼šç•«æ–œç·šã€ä¸å¯é¸ */
    .quick-time-btn.taken {
      position: relative;
      pointer-events: none;
      cursor: not-allowed;
      opacity: 0.55;
      color: var(--text-sub);
      border-color: #d6d3d1;
      background: #fafaf9;
    }
    .quick-time-btn.taken::after {
      content: '';
      position: absolute;
      left: 2px;
      right: 2px;
      top: 50%;
      height: 1.5px;
      background: var(--text-sub);
      transform: rotate(-35deg);
      transform-origin: center;
    }


    /* æ—¥æœŸè©³æƒ…è¦–åœ–ï¼šå·¦åˆ—è¡¨ + å³è¡¨å–® */
    .day-view-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .day-view-title {
      font-size: 16px;
      font-weight: 600;
    }

    .btn-back-calendar {
      border: none;
      background: var(--border);
      border-radius: var(--radius);
      min-height: 40px;
      padding: 8px 16px;
      font-size: 14px;
      color: var(--text-main);
      cursor: pointer;
      transition: background 0.15s var(--ease), transform 0.1s var(--ease);
    }
    .btn-back-calendar:hover { background: #d6d3d1; }
    .btn-back-calendar:active { transform: scale(0.98); }

    .day-view-panels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 600px) {
      .day-view-panels {
        grid-template-columns: 1fr;
      }
    }

    .day-view-left {
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .day-view-right {
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .day-view-left-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-main);
    }

    .day-view-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-sub);
      font-size: 14px;
      line-height: 1.6;
    }
    .empty-state-icon {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    @media (max-width: 360px) {
      header h1 {
        font-size: 20px;
      }
      .field-half-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Wonder Hair é ç´„ç´€éŒ„</h1>
    <p>é»é¸æœˆæ›†ä¸Šçš„æ—¥æœŸå¯æŸ¥çœ‹ç•¶æ—¥é ç´„ä¸¦æ–°å¢é ç´„ï¼ˆè³‡æ–™åªå­˜åœ¨é€™æ”¯æ‰‹æ©Ÿï¼‰</p>
  </header>

  <!-- è¦–åœ–ä¸€ï¼šæœˆæ›†é¦–é ï¼ˆæœ‰é ç´„çš„æ—¥æœŸç¶ è‰²èƒŒæ™¯å‡¸é¡¯ï¼‰ -->
  <div id="viewCalendar" class="view-calendar active">
    <div class="calendar-main">
      <div class="calendar-header">
        <div class="calendar-title" id="calendarTitle">æœˆæ›†</div>
        <div class="calendar-nav">
          <button id="calendarPrev" type="button" aria-label="ä¸Šå€‹æœˆ">&lt; ä¸Šæœˆ</button>
          <button id="calendarNext" type="button" aria-label="ä¸‹å€‹æœˆ">ä¸‹æœˆ &gt;</button>
        </div>
      </div>
      <div class="calendar-weekdays">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
      </div>
      <div id="calendarGrid" class="calendar-grid"></div>
      <div id="calendarTodaySummary" class="calendar-today-summary" aria-live="polite"></div>
      <div class="calendar-footer" id="calendarFooter">
        æœ‰é ç´„çš„æ—¥æœŸä»¥ç¶ è‰²èƒŒæ™¯é¡¯ç¤ºï¼Œé»é¸æ—¥æœŸå¯æŸ¥çœ‹ç•¶æ—¥é ç´„ä¸¦æ–°å¢ã€‚
      </div>
    </div>
  </div>

  <!-- è¦–åœ–äºŒï¼šæ—¥æœŸè©³æƒ…ï¼ˆå·¦ï¼šç•¶æ—¥é ç´„åˆ—è¡¨ï¼Œå³ï¼šæ–°å¢é ç´„è¡¨å–®ï¼‰ -->
  <div id="viewDay" class="view-day">
    <div class="day-view-header">
      <div class="day-view-title" id="dayViewTitle">ç•¶æ—¥é ç´„</div>
      <button id="backToCalendar" type="button" class="btn-back-calendar" aria-label="å›åˆ°æœˆæ›†">â† å›åˆ°æœˆæ›†</button>
    </div>
    <div class="day-view-panels">
      <div class="day-view-left">
        <div class="day-view-left-title" id="dayViewListTitle">ç•¶æ—¥é ç´„åˆ—è¡¨</div>
        <div id="dayViewList" class="day-view-list" role="list"></div>
      </div>
      <div class="day-view-right">
        <div class="day-view-left-title">æ–°å¢é ç´„</div>
        <form id="appointmentForm" class="form">
          <div class="field">
            <label for="name">å®¢äººå§“å *</label>
            <input id="name" type="text" placeholder="ä¾‹ï¼šç‹å°å§" required autocomplete="name" />
          </div>
          <div class="field">
            <label>å¿«é€Ÿé¸æ™‚é–“</label>
            <div class="quick-time-row" id="quickTimeRow">
              <button type="button" class="quick-time-btn" data-time="09:00">09:00</button>
              <button type="button" class="quick-time-btn" data-time="10:00">10:00</button>
              <button type="button" class="quick-time-btn" data-time="11:00">11:00</button>
              <button type="button" class="quick-time-btn" data-time="14:00">14:00</button>
              <button type="button" class="quick-time-btn" data-time="15:00">15:00</button>
              <button type="button" class="quick-time-btn" data-time="16:00">16:00</button>
              <button type="button" class="quick-time-btn" data-time="17:00">17:00</button>
              <button type="button" class="quick-time-btn" data-time="18:00">18:00</button>
            </div>
          </div>
          <div class="field-half-row">
            <div class="field">
              <label for="date">æ—¥æœŸ *</label>
              <input id="date" type="date" required />
            </div>
            <div class="field">
              <label for="time">æ™‚é–“ *</label>
              <input id="time" type="time" required />
            </div>
          </div>
          <div class="field">
            <label for="phone">è¯çµ¡é›»è©±ï¼ˆé¸å¡«ï¼‰</label>
            <input id="phone" type="tel" placeholder="ä¾‹ï¼š0912-345678" autocomplete="tel" />
          </div>
          <div class="field-half-row">
            <div class="field">
              <label for="service">æœå‹™é …ç›® *</label>
              <select id="service" required>
                <option value="">è«‹é¸æ“‡</option>
                <option>å‰ªé«®</option>
                <option>æ´—å‰ª</option>
                <option>æŸ“é«®</option>
                <option>ç‡™é«®</option>
                <option>è­·é«®</option>
                <option>é ­çš®è­·ç†</option>
                <option>å…¶ä»–</option>
              </select>
            </div>
            <div class="field">
              <label for="duration">é ä¼°æ™‚é–“ï¼ˆé¸å¡«ï¼‰</label>
              <select id="duration">
                <option value="">è«‹é¸æ“‡</option>
                <option value="30">30åˆ†é˜</option>
                <option value="60">1å°æ™‚</option>
                <option value="90">1æ™‚30åˆ†</option>
                <option value="120">2å°æ™‚</option>
                <option value="150">2æ™‚30åˆ†</option>
                <option value="180">3æ™‚</option>
                <option value="240">4æ™‚</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label for="note">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="note" placeholder="ä¾‹ï¼šç¬¬ä¸€æ¬¡ä¾† / å¾å°å‰ªçŸ­ / é¡è‰²è¦è‡ªç„¶ä¸€é»"></textarea>
          </div>
          <button type="submit" class="btn-primary">
            <span id="submitText">æ–°å¢é ç´„</span>
          </button>
          <input type="hidden" id="editingId" />
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast æç¤º -->
<div id="toastWrap" class="toast-wrap" role="status" aria-live="polite">
  <div id="toast" class="toast"></div>
</div>

<script>
  const STORAGE_KEY = 'hair_appointments_v1';

  function loadAppointments() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error(e);
      return [];
    }
  }

  function saveAppointments(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  function getTodayStr() {
    var d = new Date();
    var m = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    return d.getFullYear() + '-' + m + '-' + day;
  }

  function formatDateFriendly(ymd) {
    if (!ymd) return '';
    var parts = ymd.split('-');
    if (parts.length !== 3) return ymd;
    return parts[0] + 'å¹´' + parseInt(parts[1], 10) + 'æœˆ' + parseInt(parts[2], 10) + 'æ—¥';
  }

  const form = document.getElementById('appointmentForm');
  const nameInput = document.getElementById('name');
  const dateInput = document.getElementById('date');
  const timeInput = document.getElementById('time');
  const serviceInput = document.getElementById('service');
  const noteInput = document.getElementById('note');
  const durationInput = document.getElementById('duration');
  const editingIdInput = document.getElementById('editingId');
  const submitText = document.getElementById('submitText');

  const viewCalendar = document.getElementById('viewCalendar');
  const viewDay = document.getElementById('viewDay');
  const dayViewTitle = document.getElementById('dayViewTitle');
  const dayViewList = document.getElementById('dayViewList');
  const backToCalendarBtn = document.getElementById('backToCalendar');

  const calendarTitle = document.getElementById('calendarTitle');
  const calendarGrid = document.getElementById('calendarGrid');
  const calendarTodaySummary = document.getElementById('calendarTodaySummary');
  const calendarPrev = document.getElementById('calendarPrev');
  const calendarNext = document.getElementById('calendarNext');
  const dayViewListTitle = document.getElementById('dayViewListTitle');
  const toastWrap = document.getElementById('toastWrap');
  const toastEl = document.getElementById('toast');
  const phoneInput = document.getElementById('phone');

  let appointments = loadAppointments();
  let calendarYear;
  let calendarMonth;
  let selectedDate = getTodayStr();
  let toastTimer = null;

  dateInput.value = getTodayStr();
  (function initCalendarYM() {
    const d = new Date();
    calendarYear = d.getFullYear();
    calendarMonth = d.getMonth();
  })();

  function showToast(message, type) {
    if (toastTimer) clearTimeout(toastTimer);
    toastEl.textContent = message;
    toastEl.className = 'toast' + (type ? ' ' + type : '');
    toastWrap.classList.add('show');
    toastWrap.setAttribute('aria-label', message);
    toastTimer = setTimeout(function() {
      toastWrap.classList.remove('show');
    }, 2500);
  }

  function showView(view) {
    if (view === 'calendar') {
      viewCalendar.classList.add('active');
      viewDay.classList.remove('active');
      renderCalendar();
    } else {
      viewCalendar.classList.remove('active');
      viewDay.classList.add('active');
      dayViewTitle.textContent = formatDateFriendly(selectedDate) + ' ç•¶æ—¥é ç´„';
      dateInput.value = selectedDate;
      renderDayView();
      updateQuickTimeAvailability();
    }
  }

  function renderDayView() {
    const list = appointments
      .filter(a => a.date === selectedDate)
      .sort((a, b) => (a.time || '').localeCompare(b.time || ''));

    dayViewList.innerHTML = '';
    dayViewListTitle.textContent = list.length ? `ç•¶æ—¥é ç´„åˆ—è¡¨ï¼ˆ${list.length} ç­†ï¼‰` : 'ç•¶æ—¥é ç´„åˆ—è¡¨';

    if (list.length === 0) {
      dayViewList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“…</div>é€™ä¸€å¤©ç›®å‰æ²’æœ‰é ç´„<br>åœ¨å³å´è¡¨å–®æ–°å¢ä¸€ç­†å§</div>';
      return;
    }

    list.forEach(item => {
      const div = document.createElement('div');
      div.className = 'item';
      div.setAttribute('role', 'listitem');
      div.innerHTML = `
        <div class="item-header">
          <div>
            <div class="item-name">${escapeHtml(item.name)}</div>
            ${item.phone ? `<div class="item-service" style="font-size:12px;">${escapeHtml(item.phone)}</div>` : ''}
            <div class="item-service">
              ${escapeHtml(item.service)}
              ${item.duration ? ` Â· é ä¼° ${escapeHtml(item.duration)} åˆ†é˜` : ''}
            </div>
          </div>
          <div style="text-align: right;">
            <div class="item-time">${item.time ? item.time : ''}</div>
          </div>
        </div>
        <div class="item-footer">
          <div class="item-actions">
            <button type="button" class="btn-secondary" data-action="edit" data-id="${item.id}">ç·¨è¼¯</button>
            <button type="button" class="btn-danger" data-action="delete" data-id="${item.id}">åˆªé™¤</button>
          </div>
        </div>
        ${item.note ? `<div class="item-note">${escapeHtml(item.note)}</div>` : ''}
      `;
      dayViewList.appendChild(div);
    });
    updateQuickTimeAvailability();
  }

  function renderCalendar() {
    const base = new Date(calendarYear, calendarMonth, 1);
    const year = base.getFullYear();
    const month = base.getMonth(); // 0-11

    calendarTitle.textContent = `${year} å¹´ ${month + 1} æœˆ`;

    // è¨ˆç®—ç•¶æœˆè³‡æ–™
    const firstDay = new Date(year, month, 1).getDay(); // 0(æ—¥) - 6(å…­)
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const prevMonthDays = new Date(year, month, 0).getDate();

    // æŠŠæ‰€æœ‰é ç´„ä¾æ—¥æœŸå½™æ•´æˆ map
    const countMap = {};
    appointments.forEach(a => {
      if (!a.date) return;
      countMap[a.date] = (countMap[a.date] || 0) + 1;
    });

    calendarGrid.innerHTML = '';

    const cells = 42; // 6 é€± * 7 å¤©
    for (let i = 0; i < cells; i++) {
      const cell = document.createElement('div');
      cell.className = 'calendar-day';

      let displayDay;
      let cellYear = year;
      let cellMonth = month;
      let inCurrentMonth = true;

      if (i < firstDay) {
        // ä¸Šä¸€å€‹æœˆ
        displayDay = prevMonthDays - (firstDay - 1 - i);
        inCurrentMonth = false;
        if (month === 0) {
          cellYear = year - 1;
          cellMonth = 11;
        } else {
          cellMonth = month - 1;
        }
      } else if (i >= firstDay + daysInMonth) {
        // ä¸‹ä¸€å€‹æœˆ
        displayDay = i - (firstDay + daysInMonth) + 1;
        inCurrentMonth = false;
        if (month === 11) {
          cellYear = year + 1;
          cellMonth = 0;
        } else {
          cellMonth = month + 1;
        }
      } else {
        // æœ¬æœˆ
        displayDay = i - firstDay + 1;
      }

      const mm = String(cellMonth + 1).padStart(2, '0');
      const dd = String(displayDay).padStart(2, '0');
      const dateStr = `${cellYear}-${mm}-${dd}`;

      cell.textContent = displayDay;

      if (!inCurrentMonth) {
        cell.classList.add('calendar-day-other');
      }

      const todayStr = getTodayStr();
      if (dateStr === todayStr) {
        cell.classList.add('calendar-day-today');
      }

      if (countMap[dateStr]) {
        cell.classList.add('calendar-day-has');
      }

      cell.addEventListener('click', () => {
        selectedDate = dateStr;
        showView('day');
      });

      calendarGrid.appendChild(cell);
    }

    var todayStr = getTodayStr();
    var todaysCount = appointments.filter(function(a) { return a.date === todayStr; }).length;
    if (todaysCount > 0) {
      calendarTodaySummary.innerHTML = 'ä»Šæ—¥å…± <strong>' + todaysCount + '</strong> ç­†é ç´„ï¼Œé»é¸ä¸Šæ–¹æ—¥æœŸå¯æŸ¥çœ‹æˆ–æ–°å¢ã€‚';
      calendarTodaySummary.style.display = 'block';
    } else {
      calendarTodaySummary.innerHTML = 'ä»Šæ—¥å°šç„¡é ç´„ï¼Œé»é¸æ—¥æœŸå¯ç‚ºè©²æ—¥æ–°å¢é ç´„ã€‚';
      calendarTodaySummary.style.display = 'block';
    }
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    var name = nameInput.value.trim();
    var date = dateInput.value;
    var time = timeInput.value;
    var service = serviceInput.value;
    var duration = durationInput ? durationInput.value.trim() : '';
    var note = noteInput.value.trim();
    var phone = (phoneInput && phoneInput.value) ? phoneInput.value.trim() : '';
    var editingId = editingIdInput.value;

    if (!name || !date || !time || !service) {
      showToast('è«‹å¡«å¯«å§“åã€æ—¥æœŸã€æ™‚é–“èˆ‡æœå‹™é …ç›®', 'danger');
      return;
    }

    if (editingId) {
      appointments = appointments.map(function(a) {
        if (a.id === editingId) {
          return Object.assign({}, a, { name: name, date: date, time: time, service: service, note: note, duration: duration, phone: phone });
        }
        return a;
      });
      showToast('å·²å„²å­˜ä¿®æ”¹', 'success');
    } else {
      var id = Date.now().toString();
      appointments.push({ id: id, name: name, date: date, time: time, service: service, note: note, duration: duration, phone: phone, createdAt: Date.now() });
      showToast('å·²æ–°å¢é ç´„', 'success');
    }

    saveAppointments(appointments);
    resetForm();
    if (viewDay.classList.contains('active')) {
      selectedDate = date;
      dayViewTitle.textContent = formatDateFriendly(selectedDate) + ' ç•¶æ—¥é ç´„';
      renderDayView();
    }
    if (viewCalendar.classList.contains('active')) {
      renderCalendar();
    }
  });

  function resetForm() {
    form.reset();
    editingIdInput.value = '';
    submitText.textContent = 'æ–°å¢é ç´„';
    dateInput.value = selectedDate || getTodayStr();
    if (durationInput) durationInput.value = '';
    if (phoneInput) phoneInput.value = '';
  }

  dayViewList.addEventListener('click', function(e) {
    var btn = e.target.closest('button');
    if (!btn) return;

    var action = btn.dataset.action;
    var id = btn.dataset.id;

    if (action === 'delete') {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é ç´„ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚')) return;
      appointments = appointments.filter(function(a) { return a.id !== id; });
      saveAppointments(appointments);
      renderDayView();
      if (viewCalendar.classList.contains('active')) renderCalendar();
      showToast('å·²åˆªé™¤é ç´„', 'danger');
    } else if (action === 'edit') {
      var item = appointments.find(function(a) { return a.id === id; });
      if (!item) return;

      nameInput.value = item.name;
      dateInput.value = item.date;
      timeInput.value = item.time || '';
      serviceInput.value = item.service;
      noteInput.value = item.note || '';
      durationInput.value = item.duration || '';
      editingIdInput.value = item.id;
      if (phoneInput) phoneInput.value = item.phone || '';
      durationInput.value = item.duration || '';
      submitText.textContent = 'å„²å­˜ä¿®æ”¹';
    }
  });

  function normalizeTimeStr(str) {
    if (!str || typeof str !== 'string') return '';
    var parts = str.trim().match(/^(\d{1,2}):(\d{2})$/);
    if (!parts) return str.trim();
    var h = parseInt(parts[1], 10);
    var m = parts[2];
    return (h < 10 ? '0' : '') + h + ':' + m;
  }

  function timeToMinutes(str) {
    if (!str || typeof str !== 'string') return -1;
    var parts = str.trim().match(/^(\d{1,2}):(\d{2})$/);
    if (!parts) return -1;
    return parseInt(parts[1], 10) * 60 + parseInt(parts[2], 10);
  }

  function updateQuickTimeAvailability() {
    var timeRow = document.getElementById('quickTimeRow');
    if (!timeRow) return;
    var editingId = editingIdInput ? editingIdInput.value : '';
    var intervals = [];
    appointments
      .filter(function(a) { return a.date === selectedDate && a.id !== editingId && a.time; })
      .forEach(function(a) {
        var startM = timeToMinutes(a.time);
        if (startM < 0) return;
        var dur = parseInt(a.duration, 10) || 60;
        if (dur <= 0) dur = 60;
        intervals.push({ start: startM, end: startM + dur });
      });
    function isSlotTaken(slotMinutes) {
      for (var i = 0; i < intervals.length; i++) {
        var r = intervals[i];
        if (slotMinutes >= r.start && slotMinutes < r.end) return true;
      }
      return false;
    }
    timeRow.querySelectorAll('.quick-time-btn').forEach(function(btn) {
      var t = btn.dataset.time;
      var slotM = t ? timeToMinutes(t) : -1;
      var taken = slotM >= 0 && isSlotTaken(slotM);
      btn.classList.toggle('taken', !!taken);
      btn.setAttribute('aria-disabled', taken ? 'true' : 'false');
      btn.title = taken ? 'æ­¤æ™‚æ®µåœ¨é ç´„æ“ä½œæ™‚é–“å…§ï¼Œç„¡æ³•é¸æ“‡' : '';
    });
  }

  document.getElementById('quickTimeRow').addEventListener('click', function(e) {
    var btn = e.target.closest('.quick-time-btn');
    if (!btn) return;
    if (btn.classList.contains('taken')) return;
    var t = btn.dataset.time;
    if (t) timeInput.value = t;
  });

  backToCalendarBtn.addEventListener('click', () => {
    showView('calendar');
  });

  calendarPrev.addEventListener('click', () => {
    if (calendarMonth === 0) {
      calendarMonth = 11;
      calendarYear -= 1;
    } else {
      calendarMonth -= 1;
    }
    renderCalendar();
  });

  calendarNext.addEventListener('click', () => {
    if (calendarMonth === 11) {
      calendarMonth = 0;
      calendarYear += 1;
    } else {
      calendarMonth += 1;
    }
    renderCalendar();
  });

  showView('calendar');
</script>
</body>
</html>
